@extends('layouts.master')
@section('title', 'ุงูุญุฌูุฒุงุช')

@section('style')

    <link href="{{ asset('css/app.css') }}" rel="stylesheet">
    <script src="{{ asset('js/app.js') }}" defer></script>
    <!-- ุชุถููู ููุชุจุฉ FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.9/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.9/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.9/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.9/index.global.min.js"></script>
    <!-- ุชุถููู ููู ุงููุบุฉ ุงูุนุฑุจูุฉ -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.9/locales/ar.global.min.js"></script>
    <!-- ุชุถููู ููุชุจุฉ axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- ุชุถููู Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ุชุถููู Toastr CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <style>
        input[type="date"],
        input[type="time"] {
            max-width: 150px;
            text-align: center;
            font-size: 14px;
        }


        .modal-dialog {
            max-width: 90%;
            /* ุฒูุงุฏุฉ ุนุฑุถ ุงูููุฏุงู */
        }

        .select2-container {
            z-index: 1055;
            /* ุชุฃูุฏ ูู ุฃู select2 ูุธูุฑ ููู ูุญุชููุงุช ุงูููุฏุงู */
        }
    </style>
@endsection

@section('content')
    <div class="app-content content">
        <div class="content-wrapper">
            <div class="content-header row">
                <div class="content-header-left col-md-6 col-12 mb-2">
                    <h3 class="content-header-title">{{ __('ุงูุญุฌูุฒุงุช') }}</h3>
                </div>
            </div>
            <!-- ุฒุฑ ุฅุถุงูุฉ ุญุฏุซ ุฌุฏูุฏ -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reservationModal">
                ุฅุถุงูุฉ ุญุฌุฒ
            </button>
            <!-- ุงูุชูููู -->
            <div id="calendar" class="mt-4"></div>

            <!-- Modal ูุฅุถุงูุฉ ุญุฏุซ ุฌุฏูุฏ -->


            <!-- Modal ูุนุฑุถ ุชูุงุตูู ุงูุญุฏุซ -->
            <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel"
            aria-hidden="true">
           <div class="modal-dialog">
               <div class="modal-content">
                   <div class="modal-header">
                       <h5 class="modal-title" id="eventDetailsModalLabel">ุชูุงุตูู ุงูุญุฌุฒ</h5>
                       <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                   </div>
                   <div class="modal-body">
                       <!-- ุงุณุชุฎุฏุงู ุตููู ูุฃุนูุฏุฉ ูุชูุณูู ุงูุญููู -->
                       <div class="row mb-3">
                           <div class="col-md-6">
                               <strong>ุงุณู ุงูุฒุจูู:</strong> <span id="eventDetailsClient"></span>
                           </div>
                           <div class="col-md-6">
                               <strong>ุงุณู ุงูููุธู:</strong> <span id="eventDetailsUser"></span>
                           </div>
                       </div>
                       
                       <div class="row mb-3">
                           <div class="col-md-6">
                               <strong>ุนููุงู ุงูุญุฌุฒ:</strong> <span id="eventDetailsTitle"></span>
                           </div>
                           <div class="col-md-6">
                               <strong>ุฑูู ุงููุงุชู:</strong> <span id="eventDetailsPhone"></span>
                           </div>
                       </div>
                       
                       <div class="row mb-3">
                           <div class="col-md-6">
                               <strong>ููุนุฏ ุงูุญุฌุฒ :</strong> <span id="eventDetailsStart"></span>
                           </div>
                           <div class="col-md-6">
                               <strong>ุนููุงู ุงูุนููู:</strong> <span id="eventDetailsaddress"></span>
                           </div>
                       </div>
                       
                       <div class="row mb-3">
                           <div class="col-md-6">
                               <strong>ุงูุณุจุจ:</strong> <span id="eventDetailsReason"></span>
                           </div>
                           <div class="col-md-6">
                               <strong>ุงูููุงุญุธุงุช:</strong> <span id="eventDetailsNots"></span>
                           </div>
                       </div>
       
                       <div class="mb-3">
                           <strong>ุงูุฎุฏูุงุช:</strong>
                           <ul id="eventDetailsServices" class="list-group"></ul> <!-- ูุงุฆูุฉ ุงูุฎุฏูุงุช -->
                       </div>
                   </div>
                   <div class="modal-footer">
                       <button type="button" class="btn btn-danger" onclick="deleteEvent()">ุญุฐู ุงูุญุฌุฒ</button>
                       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                   </div>
               </div>
           </div>
       </div>
       
            <!-- ููุฏุงู ุงูุญุฌุฒ -->
            <div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg"> <!-- modal-lg ูุชูุณูุน ุงูููุฏุงู -->
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="reservationModalLabel">ุฅุถุงูุฉ ุญุฌุฒ</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ุฅุบูุงู"></button>
                        </div>
                        <form action="{{ route('reservations.store') }}" method="POST">
                            @csrf
                            <div class="modal-body">
                                <div class="row">
                                    <!-- ุงุณู ุงูุฒุจูู -->
                                    <div class="col-md-6 mb-3">
                                        <label for="client_id" class="form-label">ุงุณู ุงูุฒุจูู <span
                                                class="text-danger">*</span></label>
                                        <select name="client_id" id="client_id" class="form-control" required>
                                            <option value="" disabled selected>ุงุฎุชุฑ ุงูุนููู</option>
                                            @foreach ($clients as $client)
                                                <option value="{{ $client->id }}">{{ $client->name }}</option>
                                            @endforeach
                                        </select>
                                    </div>

                                    <!-- ุนููุงู ุงูุญุฌุฒ -->
                                    <div class="col-md-6 mb-3">
                                        <label for="title" class="form-label">ุนููุงู ุงูุญุฌุฒ <span
                                                class="text-danger">*</span></label>
                                        <input type="text" name="title" id="title" class="form-control"
                                            value="{{ old('title') }}" required>
                                    </div>

                                    <!-- ุงูุชุงุฑูุฎ -->

                                    <div class="form-group border rounded p-3 bg-white shadow-sm">
                                        <label class="font-weight-bold mb-2">๐๏ธ ุชุงุฑูุฎ ุงูุญุฌุฒ</label>

                                        <div class="d-flex align-items-center flex-wrap">
                                            <div class="d-flex align-items-center mr-3 mb-2">
                                                <i class="far fa-clock mr-2 text-muted"></i>
                                                <input type="date"
                                                    class="form-control rounded-pill bg-light border-0 px-3 py-2"
                                                    name="date" required>
                                            </div>

                                            <div class="d-flex align-items-center mb-2">
                                                <input type="time"
                                                    class="form-control rounded-pill bg-light border-0 px-3 py-2 mr-2"
                                                    name="start_time" required>
                                                <span class="mx-1">โ</span>
                                                <input type="time"
                                                    class="form-control rounded-pill bg-light border-0 px-3 py-2"
                                                    name="end_time" required>
                                            </div>
                                        </div>
                                    </div>


                                    <!-- ุงุณู ุงูููุธู -->
                                    <div class="col-md-6 mb-3">
                                        <label for="user_id" class="form-label">ุงุณู ุงูููุธู <span
                                                class="text-danger">*</span></label>
                                        <select name="user_id" id="user_id" class="form-control" required>
                                            <option value="" disabled selected>ุงุฎุชุฑ ุงููุณุชุฎุฏู</option>
                                            @foreach ($users as $user)
                                                <option value="{{ $user->id }}">{{ $user->name }}</option>
                                            @endforeach
                                        </select>
                                    </div>

                                    <!-- ุงูุฎุฏูุงุช -->
                                    <div class="col-md-6 mb-3">
                                        <label for="services" class="form-label">ุงูุฎุฏูุงุช <span
                                                class="text-danger">*</span></label>
                                        <select name="services[]" id="services" class="form-control select2" multiple>
                                            @foreach ($services as $service)
                                                <option value="{{ $service->id }}">{{ $service->title }} -
                                                    {{ $service->price }} ุดููู</option>
                                            @endforeach
                                        </select>
                                    </div>

                                    <!-- ุงูููุงุญุธุงุช -->
                                    <div class="col-md-6 mb-3">
                                        <label for="nots" class="form-label">ุงูููุงุญุธุงุช</label>
                                        <textarea name="nots" id="nots" class="form-control">{{ old('nots') }}</textarea>
                                    </div>

                                    <!-- ุงูุณุจุจ -->
                                    <div class="col-md-6 mb-3">
                                        <label for="reason" class="form-label">ุงูุณุจุจ</label>
                                        <textarea name="reason" id="reason" class="form-control">{{ old('reason') }}</textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-success">ุญูุธ ุงูุญุฌุฒ</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
@endsection

@section('script')
    <!-- ุชุถููู Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ุชุถููู Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ุงูุชุญูู ุนูุฏ ุชุบููุฑ ุญูู ููุช ุงูููุงูุฉ
            const endTimeInput = document.querySelector('[name="end_time"]');
            endTimeInput.addEventListener('change', function() {
                const startDate = document.querySelector('[name="date"]').value;
                const startTime = document.querySelector('[name="start_time"]').value;
                const endTime = endTimeInput.value;

                // ุชุญููู ุงูุชุงุฑูุฎ ูุงูููุช ุฅูู ุทูุงุจุน ุฒูููุฉ
                const startDateTime = new Date(startDate + 'T' + startTime);
                const endDateTime = new Date(startDate + 'T' + endTime);

                if (endDateTime <= startDateTime) {
                    // ุฅุฐุง ูุงู ููุช ุงูููุงูุฉ ุฃุตุบุฑ ุฃู ูุณุงูู ููุช ุงูุจุฏุงูุฉ
                    alert('ุชุงุฑูุฎ ูููุช ุงูููุงูุฉ ูุฌุจ ุฃู ูููู ุจุนุฏ ุชุงุฑูุฎ ูููุช ุงูุจุฏุงูุฉ');
                    endTimeInput.value = ''; // ุฅูุฑุงุบ ุญูู ููุช ุงูููุงูุฉ
                }
            });
        });
    </script>


    <script>
        $(document).ready(function() {
            $('#services').select2({
                dropdownParent: $('#reservationModal') // ุชุญุฏูุฏ ุงูููุฏุงู ูุฃุจ ูููุงุฆูุฉ ุงูููุณุฏูุฉ
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek', // ุงูุนุฑุถ ุงูุงูุชุฑุงุถู (ุฃุณุจูุนู)
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                locale: 'ar', // ุชุนููู ุงููุบุฉ ุงูุนุฑุจูุฉ
                direction: 'rtl', // ุงุชุฌุงู ุงููุต ูู ุงููููู ูููุณุงุฑ
                events: "{{ route('events.index') }}", // ุฑุงุจุท ูุฌูุจ ุงูุฃุญุฏุงุซ
                editable: true, // ุชูุนูู ุชุญุฑูุฑ ุงูุฃุญุฏุงุซ
                selectable: true, // ุชูุนูู ุงุฎุชูุงุฑ ุงูุชูุงุฑูุฎ
                slotMinTime: '08:00:00', // ูุจุฏุฃ ุงูุชูููู ูู ุงูุณุงุนุฉ 8 ุตุจุงุญูุง
                eventClick: function(info) {
                    const startDate = info.event.start;
                    const endDate = info.event.end;

                    // ุชูุณูู ุงูุชุงุฑูุฎ ุจุงุณุชุฎุฏุงู toLocaleDateString ู toLocaleTimeString
                    const formattedStartDate = startDate.toLocaleDateString('ar-EG', {
                        weekday: 'long', // ุงูููู ุจุงูุฃุณู
                        day: 'numeric', // ุงูููู ุจุงูุฃุฑูุงู
                        month: 'long', // ุงูุดูุฑ ุจุงูุฃุณู
                        year: 'numeric', // ุงูุณูุฉ ุจุงูุฃุฑูุงู
                    });

                    const formattedStartTime = startDate.toLocaleTimeString('ar-EG', {
                        hour: '2-digit', // ุณุงุนุฉ
                        minute: '2-digit', // ุฏูููุฉ
                    });

                    const formattedEndTime = endDate.toLocaleTimeString('ar-EG', {
                        hour: '2-digit', // ุณุงุนุฉ
                        minute: '2-digit', // ุฏูููุฉ
                    });

                    // ุฏูุฌ ุงููุตูุต ูุนูุง ูุน ุฅุถุงูุฉ ุงููุฆุงุช ุงูููุงุณุจุฉ ููุฃููุงุช
                    document.getElementById('eventDetailsStart').innerHTML =
                        `${formattedStartDate} ูู <span style="font-weight: bold; color: red;">${formattedStartTime}</span> ุงูู <span style="font-weight: bold; color: red;">${formattedEndTime}</span>`;

                    document.getElementById('eventDetailsNots').textContent = info.event.extendedProps
                        .nots || 'ูุง ููุฌุฏ ููุงุญุธุงุช';
                    document.getElementById('eventDetailsClient').textContent = info.event.extendedProps
                        .client || 'ุบูุฑ ูุญุฏุฏ';
                    document.getElementById('eventDetailsUser').textContent = info.event.extendedProps
                        .user || 'ุบูุฑ ูุญุฏุฏ';
                    document.getElementById('eventDetailsPhone').textContent = info.event.extendedProps
                        .phone_number || 'ุบูุฑ ูุญุฏุฏ';
                    document.getElementById('eventDetailsReason').textContent = info.event.extendedProps
                        .reason || 'ุบูุฑ ูุญุฏุฏ';
                    document.getElementById('eventDetailsaddress').textContent = info.event
                        .extendedProps.address || 'ุบูุฑ ูุญุฏุฏ';

                    const servicesList = document.getElementById('eventDetailsServices');
                    servicesList.innerHTML = '';
                    if (info.event.extendedProps.services && info.event.extendedProps.services.length >
                        0) {
                        info.event.extendedProps.services.forEach(service => {
                            const li = document.createElement('li');
                            li.textContent = `${service.title} - ${service.price} ุดููู`;
                            servicesList.appendChild(li);
                        });
                    } else {
                        servicesList.innerHTML = '<li>ูุง ุชูุฌุฏ ุฎุฏูุงุช ูุฑุชุจุทุฉ</li>';
                    }

                    document.querySelector('#eventDetailsModal .btn-danger').setAttribute(
                        'data-event-id', info.event.id);

                    const eventDetailsModal = new bootstrap.Modal(document.getElementById(
                        'eventDetailsModal'));
                    eventDetailsModal.show();
                }
            });


            calendar.render(); // ุนุฑุถ ุงูุชูููู
        });

        // ุฏุงูุฉ ูุญูุธ ุงูุญุฏุซ
        function saveEvent() {
            const title = document.getElementById('eventTitle').value;
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            const nots = document.getElementById('nots').value;

            if (title && start && end) {
                axios.post("{{ route('events.store') }}", {
                    title: title,
                    start: start,
                    end: end,
                    nots: nots
                }).then(response => {
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูุฃุญุฏุงุซ ูุฅุบูุงู ุงูู Modal
                    document.getElementById('eventForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();

                    // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ุจุงุณุชุฎุฏุงู Toastr
                    toastr.success('ุชู ุฅุถุงูุฉ ุงูุญุฏุซ ุจูุฌุงุญ!', 'ูุฌุงุญ');

                    setTimeout(function() {
                        window.location.reload();
                    }, 1000); // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุญุฏูุซ ุงูุชูููู
                }).catch(error => {
                    // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ ูู ุญุงูุฉ ูุดู ุงูุนูููุฉ
                    toastr.error('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูุญุฏุซ!', 'ุฎุทุฃ');
                });
            } else {
                alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
            }
        }

        // ุฏุงูุฉ ูุญุฐู ุงูุญุฏุซ
        function deleteEvent() {
    const eventId = document.querySelector('#eventDetailsModal .btn-danger').getAttribute('data-event-id');

    // ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ ูููุณุชุฎุฏู ูุจู ุชูููุฐ ุงูุญุฐู
    const userConfirmed = confirm('ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุญุฌุฒุ');

    if (userConfirmed && eventId) {
        // ุฅุฐุง ุฃูุฏ ุงููุณุชุฎุฏูุ ูู ุจุฅุฑุณุงู ุทูุจ ุงูุญุฐู
        axios.get("{{ route('events.destroy', ['id' => 'PLACEHOLDER']) }}".replace('PLACEHOLDER', eventId))
            .then(response => {
                // ุฅุบูุงู ุงูู Modal ูุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
                bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal')).hide();

                // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ุจุงุณุชุฎุฏุงู Toastr
                toastr.success('ุชู ุญุฐู ุงูุญุฏุซ ุจูุฌุงุญ!', 'ูุฌุงุญ');

                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            }).catch(error => {
                // ุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ ูู ุญุงูุฉ ูุดู ุงูุนูููุฉ
                toastr.error('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุญุฏุซ!', 'ุฎุทุฃ');
            });
    } else {
        // ูู ุญุงู ุฑูุถ ุงููุณุชุฎุฏู
        toastr.info('ุชู ุฅูุบุงุก ุนูููุฉ ุงูุญุฐู', 'ุฅูุบุงุก');
    }
}

    </script>
    <script>
        $(document).ready(function() {
            // ุชููุฆุฉ Select2
            $('.select2').select2({
                placeholder: "{{ __('ุงุฎุชุฑ') }}",
                allowClear: true
            });

            // ุฏุงูุฉ ุงูุชุญูู ูู Select2
            function validateSelect2Field(selector) {
                let select2Element = $(selector);
                let parentDiv = select2Element.closest('.form-group'); // ุงูุจุญุซ ุนู ุฃูุฑุจ div ูุญุชูู ุนูู input
                let errorMessage = parentDiv.find('.select2-error-message');

                if (select2Element.val() === null || select2Element.val().length === 0) {
                    parentDiv.find('.select2-selection').css('border', '2px solid red'); // ุฅุถุงูุฉ ุฅุทุงุฑ ุฃุญูุฑ
                    if (errorMessage.length === 0) {
                        parentDiv.append(
                            '<small class="text-danger select2-error-message">{{ __('ูุฐุง ุงูุญูู ูุทููุจ') }}</small>'
                        );
                    }
                    return false;
                } else {
                    parentDiv.find('.select2-selection').css('border', ''); // ุฅุฒุงูุฉ ุงูุฅุทุงุฑ ุงูุฃุญูุฑ
                    errorMessage.remove(); // ุญุฐู ุฑุณุงูุฉ ุงูุฎุทุฃ
                    return true;
                }
            }

            // ุชุญุฏูุซ ุงูุชุญูู ุนูุฏ ุชุบููุฑ ุงูููู
            $('#client_id, #user_id, #services').on('change', function() {
                validateSelect2Field(this);
            });

            // ุงูุชุญูู ุนูุฏ ุฅุฑุณุงู ุงููููุฐุฌ
            $('#reservationForm').on('submit', function(e) {
                let isValid = true;

                if (!validateSelect2Field('#client_id')) isValid = false;
                if (!validateSelect2Field('#user_id')) isValid = false;
                if (!validateSelect2Field('#services')) isValid = false;

                // ุฅูุบุงุก ุงูุฅุฑุณุงู ุฅุฐุง ูุงู ููุงู ุฎุทุฃ
                if (!isValid) {
                    e.preventDefault();
                    alert("{{ __('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ') }}");
                }
            });
        });
    </script>
@endsection
